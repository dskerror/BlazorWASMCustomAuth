@page "/admin/userviewedit/{id:int}"

<MudBreadcrumbs Items="_breadcrumbs"></MudBreadcrumbs>

@if (!_loaded)
{
    <h3>Loading...</h3>
    <MudProgressLinear Color="Color.Primary" Striped="true" Size="Size.Large" Value="75" Class="my-7" />
}
else
{
    if (_EditMode)
    {
        <EditForm Model="user" OnValidSubmit="EditUser">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <MudCard Class="mb-2">
                <MudCardContent>

                    <MudTextField ReadOnly="true" Label="Username" @bind-Value="user.Username"
                          For="@(()=>user.Username)">
                    </MudTextField>

                    <MudTextField Label="Email" @bind-Value="user.Email"
                          For="@(()=>user.Email)">
                    </MudTextField>

                    <MudTextField Label="Name" @bind-Value="user.Name"
                          For="@(()=>user.Name)">
                    </MudTextField>

                    <MudSwitch @bind-Checked="@user.EmailConfirmed" Label="Email Confirmed" Color="Color.Success" />

                    <MudDatePicker Label="Lockout End" Editable="true" @bind-Date="user.LockoutEnd" />

                    <MudSwitch @bind-Checked="@user.LockoutEnabled" Label="Lockout" Color="Color.Success" />

                    <MudTextField Label="Access Failed Count" @bind-Value="user.AccessFailedCount"
                          For="@(()=>user.AccessFailedCount)">
                    </MudTextField>

                    <MudSwitch @bind-Checked="@user.TwoFactorEnabled" Label="Two Factor" Color="Color.Success" />

                </MudCardContent>
            </MudCard>

            <MudButton Color="Color.Primary" ButtonType="ButtonType.Submit" Variant="Variant.Filled" Class="mb-2">Save</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CancelChanges" Class="mb-2">Cancel</MudButton>

        </EditForm>
    }
    else
    {
        <EditForm Model="user">
            <MudCard Class="mb-2">
                <MudCardContent>

                    <MudTextField ReadOnly="true" Label="Username" @bind-Value="user.Username"
                          For="@(()=>user.Username)">
                    </MudTextField>

                    <MudTextField ReadOnly="true" Label="Email" @bind-Value="user.Email"
                          For="@(()=>user.Email)">
                    </MudTextField>

                    <MudTextField ReadOnly="true" Label="Name" @bind-Value="user.Name"
                          For="@(()=>user.Name)">
                    </MudTextField>

                    <MudSwitch ReadOnly="true" @bind-Checked="@user.EmailConfirmed" Label="Email Confirmed" Color="Color.Success" />

                    <MudDatePicker ReadOnly="true" Label="Lockout End" Editable="true" @bind-Date="user.LockoutEnd" />

                    <MudSwitch ReadOnly="true" @bind-Checked="@user.LockoutEnabled" Label="Lockout" Color="Color.Success" />

                    <MudTextField ReadOnly="true" Label="Access Failed Count" @bind-Value="user.AccessFailedCount"
                          For="@(()=>user.AccessFailedCount)">
                    </MudTextField>

                    <MudSwitch ReadOnly="true" @bind-Checked="@user.TwoFactorEnabled" Label="Two Factor" Color="Color.Success" />

                </MudCardContent>
            </MudCard>
            @if (_AccessUsersEdit)
            {
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="EnableEditMode" Class="mb-2">Edit</MudButton>
            }
        </EditForm>

        <MudDivider />

        <MudExpansionPanels>
            @if (_AccessUserRolesView)
            {
                <MudExpansionPanel Text="User Roles">
                    <MudTable Items="@userRoles" Hover="true">
                        <HeaderContent>
                            <MudTh>Disabled/Enabled</MudTh>
                            <MudTh>Role Name</MudTh>
                            <MudTh>Role Description</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="RoleSwitch">
                                <MudSwitch Color="Color.Success" Disabled="!_AccessUserRolesEdit" @bind-Checked="@context.Enable" @oninput="(e)=>ToggleRoleSwitch(e,context.Id)" />
                            </MudTd>
                            <MudTd DataLabel="RoleName">@context.RoleName</MudTd>
                            <MudTd DataLabel="RoleDescription">@context.RoleDescription</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{50, 100}" />
                        </PagerContent>
                    </MudTable>
                </MudExpansionPanel>
            }
            @if (_AccessUserPermissionsView)
            {
                <MudExpansionPanel Text="User Permissions">
                    <MudTable Items="@userPermissions" Hover="true">
                        <HeaderContent>
                            <MudTh>Disabled/Enabled</MudTh>
                            <MudTh>Deny/Allow</MudTh>
                            <MudTh>Permission Name</MudTh>
                            <MudTh>Permission Description</MudTh>
                            <MudTh>In Roles</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="PermissionSwitchEnabled">
                                <MudSwitch Color="Color.Success" Disabled="!_AccessUserPermissionsEdit" @bind-Checked="@context.Enabled" @oninput="(e)=>TogglePermissionEnabledSwitch(e,context.Id, context.Allow)" />
                            </MudTd>
                            <MudTd DataLabel="PermissionSwitchAllow">
                                <MudSwitch Color="Color.Success" @bind-Checked="@context.Allow" @oninput="(e)=>TogglePermissionAllowSwitch(e,context.Id)" Disabled=@(!context.Enabled) UnCheckedColor="MudBlazor.Color.Error" />
                            </MudTd>
                            <MudTd DataLabel="PermissionName">@context.PermissionName</MudTd>
                            <MudTd DataLabel="PermissionDescription">@context.PermissionDescription</MudTd>
                            <MudTd DataLabel="Roles">@context.Roles</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{50, 100}" />
                        </PagerContent>
                    </MudTable>
                </MudExpansionPanel>
            }
            @if (_AccessUserPasswordsCreate)
            {
                <MudExpansionPanel Text="User Password">
                    <EditForm Model="userPassword" OnValidSubmit="ChangePassword">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <MudCard Class="mb-2">
                            <MudCardContent>
                                <MudTextField Label="Password" @bind-Value="userPassword.Password"
                                  For="@(()=>userPassword.Password)">
                                </MudTextField>
                            </MudCardContent>
                        </MudCard>
                        <MudButton Color="Color.Primary" ButtonType="ButtonType.Submit" Variant="Variant.Filled" Class="mb-2">Change Password</MudButton>
                    </EditForm>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    }
}